# 6.3.1 Demilitarized Zone (DMZ) Architecture

## Table of Contents

- [Overview](#overview)
- [DMZ Fundamentals](#dmz-fundamentals)
- [DMZ Topologies](#dmz-topologies)
- [DMZ Components and Services](#dmz-components-and-services)
- [DMZ Security Controls](#dmz-security-controls)
- [DMZ Design Patterns](#dmz-design-patterns)
- [Cloud DMZ Architectures](#cloud-dmz-architectures)
- [DMZ Implementation Best Practices](#dmz-implementation-best-practices)
- [Common DMZ Scenarios](#common-dmz-scenarios)
- [Related Topics](#related-topics)

---

## Overview

A Demilitarized Zone (DMZ) is a network security architecture that creates an isolated network segment between an organization's internal trusted network and the external untrusted network (typically the internet). The DMZ serves as a buffer zone that houses public-facing services while protecting the internal network from direct external access.

### Key Characteristics

| Characteristic | Description |
|----------------|-------------|
| **Isolation** | Physically or logically separated from internal network |
| **Controlled Access** | Strict firewall rules govern traffic flow |
| **Public Services** | Houses externally accessible services |
| **Defense in Depth** | Provides additional security layer |
| **Breach Containment** | Limits impact of external compromises |

### DMZ Benefits

- **Enhanced Security**: Reduces attack surface on internal network
- **Service Isolation**: Separates public services from private resources
- **Compliance**: Meets regulatory requirements for network segmentation
- **Monitoring**: Centralized logging and monitoring of external traffic
- **Risk Management**: Contains security breaches to the DMZ layer

---

## DMZ Fundamentals

### Traditional DMZ Architecture

```mermaid
graph TB
    subgraph "External Network"
        A[Internet]
        B[External Users]
        C[Business Partners]
    end
    
    subgraph "DMZ"
        D[Web Servers]
        E[Mail Servers]
        F[DNS Servers]
        G[Reverse Proxy]
        H[VPN Gateway]
    end
    
    subgraph "Internal Network"
        I[Application Servers]
        J[Database Servers]
        K[File Servers]
        L[Internal Users]
    end
    
    A --> D
    B --> E
    C --> H
    
    D -.->|Controlled| I
    E -.->|Controlled| J
    G --> I
    
    style D fill:#4a90e2,color:#ffffff
    style E fill:#4a90e2,color:#ffffff
    style F fill:#4a90e2,color:#ffffff
    style G fill:#4a90e2,color:#ffffff
    style H fill:#4a90e2,color:#ffffff
```

### Security Zones

| Zone | Trust Level | Purpose | Access Rules |
|------|-------------|---------|--------------|
| **External** | Untrusted | Internet, public networks | No access to internal resources |
| **DMZ** | Semi-trusted | Public-facing services | Limited access to internal resources |
| **Internal** | Trusted | Private corporate resources | Full access based on authorization |

### Traffic Flow Principles

1. **External to DMZ**: Allowed for specific services only
2. **DMZ to Internal**: Heavily restricted, specific protocols/ports
3. **Internal to DMZ**: Controlled administrative access
4. **Internal to External**: Through DMZ proxy or direct with filtering
5. **DMZ to External**: Limited, for updates and external dependencies

---

## DMZ Topologies

### 1. Single Firewall DMZ (Three-Legged)

```mermaid
graph LR
    A[Internet] --> B[Single Firewall<br/>3 Interfaces]
    B --> C[DMZ]
    B --> D[Internal Network]
```

**Characteristics:**
- One firewall with three network interfaces
- Cost-effective for small organizations
- Single point of failure
- Complex rule management

**Use Cases:**
- Small businesses
- Limited public services
- Budget-constrained environments

### 2. Dual Firewall DMZ (Screened Subnet)

```mermaid
graph LR
    A[Internet] --> B[External<br/>Firewall]
    B --> C[DMZ]
    C --> D[Internal<br/>Firewall]
    D --> E[Internal Network]
```

**Characteristics:**
- Two separate firewalls
- True defense in depth
- Better performance and redundancy
- More complex management

**Use Cases:**
- Medium to large enterprises
- High-security requirements
- Compliance mandates

### 3. Multi-Tier DMZ

```mermaid
graph TB
    A[Internet] --> B[Edge Firewall]
    
    subgraph "DMZ Tier 1"
        C[Web Servers]
        D[Load Balancer]
    end
    
    subgraph "DMZ Tier 2"
        E[Application Servers]
        F[API Gateway]
    end
    
    subgraph "Internal Network"
        G[Database Servers]
        H[File Servers]
    end
    
    B --> C
    B --> D
    C --> E
    D --> F
    E -.->|Restricted| G
    F -.->|Restricted| H
```

**Characteristics:**
- Multiple DMZ segments
- Granular security controls
- Complex but highly secure
- Supports microservice architectures

**Use Cases:**
- Large enterprises
- Financial services
- Healthcare organizations
- Government agencies

### 4. Virtual DMZ (Cloud/SDN)

```mermaid
graph TB
    subgraph "Virtual Network"
        A[Internet Gateway]
        
        subgraph "Public Subnet (DMZ)"
            B[Web Tier]
            C[NAT Gateway]
        end
        
        subgraph "Private Subnet"
            D[App Tier]
        end
        
        subgraph "Isolated Subnet"
            E[Database Tier]
        end
    end
    
    A --> B
    B --> D
    D --> E
    C --> D
```

**Characteristics:**
- Software-defined networking
- Cloud-native approach
- Elastic and scalable
- Policy-driven security

---

## DMZ Components and Services

### Typical DMZ Services

| Service | Purpose | Security Considerations |
|---------|---------|------------------------|
| **Web Server** | Host public websites | Hardened OS, regular patches, WAF protection |
| **Mail Server** | Email relay/gateway | Anti-spam, anti-malware, encryption |
| **DNS Server** | Public DNS resolution | Rate limiting, DNS security extensions |
| **FTP/SFTP Server** | File transfers | Encrypted protocols, access controls |
| **VPN Gateway** | Remote access | Strong authentication, encrypted tunnels |
| **Reverse Proxy** | Application delivery | SSL termination, load balancing |
| **Jump Server** | Administrative access | Multi-factor auth, session recording |

### DMZ Infrastructure Components

```mermaid
graph TB
    subgraph "DMZ Infrastructure"
        A[Load Balancer]
        B[Web Application Firewall]
        C[Intrusion Detection System]
        D[Network Monitoring]
        E[Backup Systems]
        F[Certificate Authority]
        G[Time Server (NTP)]
        H[SIEM Collector]
    end
    
    A --> B
    B --> C
    C --> D
    D --> H
```

### Service Hardening Checklist

| Component | Hardening Measures |
|-----------|-------------------|
| **Operating System** | Minimal installation, latest patches, disabled services |
| **Web Server** | Secure configuration, custom error pages, access logging |
| **Database** | Network isolation, encrypted connections, principle of least privilege |
| **Applications** | Input validation, secure coding practices, regular updates |
| **Network** | Firewall rules, intrusion detection, network segmentation |

---

## DMZ Security Controls

### Firewall Rule Design

#### Inbound Rules (External to DMZ)

```
Rule 1: Allow HTTP/HTTPS to Web Servers
Source: Any
Destination: Web Server IPs
Ports: 80, 443
Action: Allow

Rule 2: Allow SMTP to Mail Server
Source: Any
Destination: Mail Server IP
Port: 25
Action: Allow

Rule 3: Allow DNS Queries
Source: Any
Destination: DNS Server IP
Port: 53
Action: Allow

Rule 4: Deny All Other Traffic
Source: Any
Destination: DMZ
Ports: Any
Action: Deny
```

#### Outbound Rules (DMZ to Internal)

```
Rule 1: Allow Web to App Servers
Source: Web Server IPs
Destination: App Server IPs
Port: 8080
Action: Allow

Rule 2: Allow Mail to Internal Mail
Source: Mail Server IP
Destination: Internal Mail IP
Port: 25
Action: Allow

Rule 3: Deny All Other Traffic
Source: DMZ
Destination: Internal Network
Ports: Any
Action: Deny (Log)
```

### Network Access Control Lists (NACLs)

| Direction | Protocol | Port Range | Source/Destination | Action |
|-----------|----------|------------|-------------------|--------|
| Inbound | TCP | 80 | 0.0.0.0/0 | Allow |
| Inbound | TCP | 443 | 0.0.0.0/0 | Allow |
| Inbound | TCP | 25 | 0.0.0.0/0 | Allow |
| Inbound | UDP | 53 | 0.0.0.0/0 | Allow |
| Inbound | ALL | ALL | 0.0.0.0/0 | Deny |
| Outbound | TCP | 8080 | Internal Subnet | Allow |
| Outbound | TCP | 3306 | DB Subnet | Allow |
| Outbound | ALL | ALL | 0.0.0.0/0 | Deny |

### Intrusion Detection and Prevention

```mermaid
graph TB
    A[Network Traffic] --> B{IDS/IPS}
    B -->|Normal Traffic| C[Allow]
    B -->|Suspicious Pattern| D[Alert + Log]
    B -->|Known Attack| E[Block + Alert]
    
    D --> F[SIEM System]
    E --> F
    F --> G[Security Team]
```

#### IDS/IPS Rule Categories

| Category | Examples | Response |
|----------|----------|----------|
| **Signature-based** | Known exploit patterns | Block/Alert |
| **Anomaly-based** | Unusual traffic patterns | Alert/Monitor |
| **Protocol Analysis** | Protocol violations | Block/Alert |
| **Behavioral Analysis** | User behavior anomalies | Alert/Log |

---

## DMZ Design Patterns

### 1. Reverse Proxy Pattern

```mermaid
graph LR
    A[Client] --> B[Internet]
    B --> C[Reverse Proxy<br/>DMZ]
    C --> D[Web Server<br/>Internal]
    C --> E[App Server<br/>Internal]
```

**Benefits:**
- SSL termination in DMZ
- Load balancing capabilities
- Additional security layer
- Caching and compression

**Implementation:**
- Nginx, Apache HTTP Server, HAProxy
- Cloud load balancers (ALB, NLB)
- API gateways

### 2. Bastion Host Pattern

```mermaid
graph TB
    A[Administrator] --> B[Internet/VPN]
    B --> C[Bastion Host<br/>DMZ]
    C -.->|SSH/RDP| D[Internal Servers]
    
    E[Audit Logs] --> C
    F[Multi-Factor Auth] --> C
```

**Characteristics:**
- Hardened jump server
- Centralized access point
- Session monitoring and recording
- Multi-factor authentication

**Security Features:**
- Privileged access management (PAM)
- Session recording
- Time-based access
- Emergency break-glass procedures

### 3. Service Mesh DMZ Pattern

```mermaid
graph TB
    subgraph "DMZ"
        A[Ingress Gateway]
        B[Service Proxy]
    end
    
    subgraph "Internal Mesh"
        C[Service A] --> D[Sidecar A]
        E[Service B] --> F[Sidecar B]
        G[Service C] --> H[Sidecar C]
    end
    
    A --> B
    B -.->|mTLS| D
    D -.->|mTLS| F
    F -.->|mTLS| H
```

**Modern Approach:**
- Container-native security
- Mutual TLS (mTLS) everywhere
- Policy as code
- Observability built-in

---

## Cloud DMZ Architectures

### AWS DMZ Architecture

```mermaid
graph TB
    subgraph "AWS VPC"
        A[Internet Gateway]
        
        subgraph "Public Subnet (DMZ)"
            B[ALB]
            C[NAT Gateway]
            D[Bastion Host]
        end
        
        subgraph "Private Subnet"
            E[EC2 Instances]
            F[RDS Database]
        end
        
        subgraph "Security Groups"
            G[Web-SG]
            H[App-SG]
            I[DB-SG]
        end
    end
    
    A --> B
    B --> E
    C --> E
    D -.->|SSH| E
    E --> F
```

**AWS Components:**
- **VPC**: Virtual Private Cloud for network isolation
- **Subnets**: Public (DMZ) and private subnet separation
- **Security Groups**: Instance-level firewalls
- **NACLs**: Subnet-level network ACLs
- **ALB/NLB**: Application and Network Load Balancers

### Azure DMZ Architecture

```mermaid
graph TB
    subgraph "Azure VNet"
        A[Application Gateway<br/>with WAF]
        
        subgraph "DMZ Subnet"
            B[Web VMs]
            C[Azure Firewall]
        end
        
        subgraph "App Subnet"
            D[App VMs]
        end
        
        subgraph "Data Subnet"
            E[SQL Database]
        end
        
        subgraph "NSGs"
            F[Web-NSG]
            G[App-NSG]
            H[Data-NSG]
        end
    end
    
    A --> B
    B --> D
    D --> E
```

**Azure Components:**
- **VNet**: Virtual Network for isolation
- **Application Gateway**: Layer 7 load balancer with WAF
- **Azure Firewall**: Managed firewall service
- **NSGs**: Network Security Groups for traffic filtering
- **Route Tables**: Custom routing configuration

### Google Cloud DMZ Architecture

```mermaid
graph TB
    subgraph "GCP VPC"
        A[Cloud Load Balancer]
        
        subgraph "DMZ Subnet"
            B[GCE Instances]
            C[Cloud NAT]
        end
        
        subgraph "Private Subnet"
            D[GKE Cluster]
        end
        
        subgraph "Isolated Subnet"
            E[Cloud SQL]
        end
    end
    
    A --> B
    B --> D
    D --> E
    C --> D
```

**GCP Components:**
- **VPC**: Virtual Private Cloud
- **Cloud Load Balancer**: Global and regional load balancing
- **Firewall Rules**: Network-level firewall
- **Cloud NAT**: Outbound internet access for private instances
- **Private Google Access**: Access to Google services without external IP

---

## DMZ Implementation Best Practices

### Planning and Design

| Phase | Best Practice | Rationale |
|-------|---------------|-----------|
| **Assessment** | Document current network architecture | Understanding existing topology |
| **Requirements** | Define security and compliance needs | Ensuring adequate protection |
| **Design** | Plan for redundancy and scalability | Supporting business growth |
| **Testing** | Validate design in lab environment | Reducing production risks |

### Security Hardening

#### Operating System Hardening

```bash
# Example Linux hardening steps
# 1. Update system packages
apt update && apt upgrade -y

# 2. Disable unnecessary services
systemctl disable telnet
systemctl disable ftp
systemctl disable rsh

# 3. Configure firewall
ufw enable
ufw default deny incoming
ufw default allow outgoing
ufw allow 80/tcp
ufw allow 443/tcp

# 4. Set up intrusion detection
fail2ban-client start
```

#### Network Configuration

```bash
# Example network security configurations
# 1. Disable IP forwarding (unless required)
echo 'net.ipv4.ip_forward = 0' >> /etc/sysctl.conf

# 2. Enable SYN flood protection
echo 'net.ipv4.tcp_syncookies = 1' >> /etc/sysctl.conf

# 3. Disable ICMP redirect acceptance
echo 'net.ipv4.conf.all.accept_redirects = 0' >> /etc/sysctl.conf

# 4. Apply changes
sysctl -p
```

### Monitoring and Logging

#### Essential Logs to Collect

| Log Type | Source | Purpose |
|----------|--------|---------|
| **Firewall Logs** | Firewall devices | Traffic analysis, rule effectiveness |
| **Web Server Logs** | Apache/Nginx | Access patterns, attack detection |
| **System Logs** | Operating system | System events, security incidents |
| **Network Flow** | Routers/switches | Traffic analysis, anomaly detection |
| **Security Events** | IDS/IPS | Threat detection, incident response |

#### Log Analysis and SIEM Integration

```mermaid
graph TB
    subgraph "DMZ Logs"
        A[Firewall Logs]
        B[Web Server Logs]
        C[System Logs]
        D[IDS/IPS Logs]
    end
    
    subgraph "Log Processing"
        E[Log Collector]
        F[Log Parser]
        G[Correlation Engine]
    end
    
    subgraph "SIEM System"
        H[Dashboard]
        I[Alerting]
        J[Forensics]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> H
    G --> I
    G --> J
```

### Maintenance and Updates

#### Regular Maintenance Tasks

| Task | Frequency | Purpose |
|------|-----------|---------|
| **Security Patching** | Monthly | Address vulnerabilities |
| **Rule Review** | Quarterly | Optimize firewall rules |
| **Log Analysis** | Weekly | Detect security incidents |
| **Backup Verification** | Monthly | Ensure recovery capability |
| **Performance Review** | Quarterly | Optimize system performance |
| **Vulnerability Scanning** | Monthly | Identify security gaps |

---

## Common DMZ Scenarios

### E-Commerce DMZ

```mermaid
graph TB
    A[Internet] --> B[WAF]
    B --> C[Load Balancer]
    
    subgraph "DMZ"
        C --> D[Web Servers]
        E[Payment Gateway]
        F[API Gateway]
    end
    
    subgraph "Internal"
        G[Application Servers]
        H[Database Cluster]
        I[File Storage]
    end
    
    D --> G
    E -.->|PCI DSS| H
    F --> G
```

**Key Requirements:**
- PCI DSS compliance
- High availability
- SSL/TLS encryption
- Fraud detection integration

### Enterprise Email DMZ

```mermaid
graph TB
    A[Internet Mail] --> B[Anti-Spam Gateway]
    B --> C[Mail Relay]
    
    subgraph "DMZ"
        C --> D[Virus Scanning]
        D --> E[Content Filter]
        E --> F[Quarantine System]
    end
    
    subgraph "Internal"
        G[Exchange Server]
        H[Mailbox Storage]
    end
    
    F --> G
    G --> H
```

**Security Features:**
- Anti-spam protection
- Malware scanning
- Data loss prevention (DLP)
- Email encryption
- Message archiving

### Remote Access DMZ

```mermaid
graph TB
    A[Remote Users] --> B[VPN Gateway]
    B --> C[Authentication Server]
    
    subgraph "DMZ"
        C --> D[Certificate Authority]
        E[Jump Servers]
        F[VDI Gateways]
    end
    
    subgraph "Internal"
        G[Domain Controllers]
        H[File Servers]
        I[Application Servers]
    end
    
    E -.->|Controlled Access| G
    F --> I
```

**Access Controls:**
- Multi-factor authentication
- Certificate-based authentication
- Session monitoring
- Privileged access management
- Time-based access controls

---

## Related Topics

### Internal References

- [6.3 Network Security Architecture](./6.3-network-security-architecture.md) - Parent topic
- [6.1 Security Architecture](./6.1-security-architecture.md) - Zero Trust principles
- [6.2 Identity Architecture](./6.2-identity-architecture.md) - Authentication and authorization
- [6.4 Data Security Architecture](./6.4-data-security-architecture.md) - Data protection in transit

### Cloud Implementation Guides

- [Azure Networking](../../architecture-azure/networking/) - Azure DMZ implementations
- [AWS VPC Security](../../architecture-azure/networking/) - AWS DMZ best practices
- [Multi-Cloud Networking](../../architecture-general/05-cloud-infrastructure-platform-architecture/) - Hybrid DMZ architectures

### Standards and Compliance

- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework) - Security controls
- [CIS Controls](https://www.cisecurity.org/controls) - Implementation guidance
- [PCI DSS](https://www.pcisecuritystandards.org/) - Payment card industry standards
- [ISO 27001](https://www.iso.org/isoiec-27001-information-security.html) - Information security management

### Tools and Technologies

- **Firewall Solutions**: Palo Alto, Fortinet, Check Point, pfSense
- **Cloud Firewalls**: Azure Firewall, AWS WAF, Google Cloud Armor
- **IDS/IPS**: Snort, Suricata, Cisco Sourcefire
- **Monitoring**: Splunk, ELK Stack, Azure Sentinel, AWS Security Hub